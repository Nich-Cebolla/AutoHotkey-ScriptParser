?3?1
???????????????????????????????????????????????????????????
????????????????????????
??????????????????
????????????????
??

?4?1???????????
#Include Inheritance_Shared.ahk
#Include GetBaseObjects.ahk

?16?1
??????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????
??
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????
??
?????????????????????????????????????????????????????????????????????????
??
???????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????
??????????????
????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????
?????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????
??
???????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????
??
????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????
???????????????????????
???
GetPropsInfo(Obj, StopAt := GPI_STOP_AT_DEFAULT ?? ?28?1????, Exclude :=   , IncludeBaseProp := true, &OutBaseObjList?) {
    OutBaseObjList := GetBaseObjects(Obj, StopAt)
    Container := Map()
    Container.Default := Container.CaseSense := false
    for s in StrSplit(Exclude,  1?, '`s`t') {
        if (s) {
            Container.Set(s, -1)
        }
    }

    PropsInfoItemBase := PropsInfoItem(Obj)

    for Prop in ObjOwnProps(Obj) {
        if Container.Get(Prop) {
            ?4?2??????????????????
            continue
        }
        ObjSetBase(ItemBase := {
            ?16?2
???????????????????????????????
??????????????????????????????????????
????????????????????????
???????????????
                Name: Prop
            ?16?3
????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????
????????????????????????
???????????????
              , Count: 1
            }
          , PropsInfoItemBase)
        ObjSetBase(Item := ObjGetOwnPropDesc(Obj, Prop), ItemBase)
        Item.Index := 0
        Container.Set(Prop, Item)
    }
    if IncludeBaseProp {
        ObjSetBase(ItemBase := { Name: ?28?3?, Count: 1 }, PropsInfoItemBase)
        ObjSetBase(BasePropItem := { Value: Obj.Base }, ItemBase)
        BasePropItem.Index := 0
        Container.Set(?28?4?, BasePropItem)
    }
    i := 0
    for b in OutBaseObjList {
        i++
        for Prop in ObjOwnProps(b) {
            if r := Container.Get(Prop) {
                if r == -1 {
                    continue
                }
                ?4?3???????????????????????
                ObjSetBase(Item := ObjGetOwnPropDesc(b, Prop), r.Base)
                Item.Index := i
                r.__SetAlt(Item)
                r.Base.Count++
            } else {
                ?4?4?????????????????
                ObjSetBase(ItemBase := { Name: Prop, Count: 1 }, PropsInfoItemBase)
                ObjSetBase(Item := ObjGetOwnPropDesc(b, Prop), ItemBase)
                Item.Index := i
                Container.Set(Prop, Item)
            }
        }
        if IncludeBaseProp {
            ObjSetBase(Item := { Value: Obj.Base }, BasePropItem.Base)
            Item.Index := i
            BasePropItem.__SetAlt(Item)
            BasePropItem.Base.Count++
        }
    }
    for s in StrSplit(Exclude,  2?, '`s`t') {
        if (s) {
            Container.Delete(s)
        }
    }
    return PropsInfo(Container, PropsInfoItemBase)
}

?16?4
??????????????????????????????????????????????????????????????????????????????????????????????
???????????????????
???
class PropsInfo {
    static __New() {
        if this.Prototype.__Class == ?28?6?????? {
            Proto := this.Prototype
            Proto.DefineProp(?28?7???, { Value:    })
            Proto.DefineProp(?28?8???????????, { Value: 0 })
            Proto.DefineProp(?28?9?????????, { Value: 0 })
            Proto.DefineProp( 3???, Proto.GetOwnPropDesc('__ItemGet_Bitypic'))
            Proto.DefineProp(?28?11????????????????, { Value: ['Has', 'ToArray', 'ToMap'
            , ?28?12????, 'Count', 'Length'] })
            Proto.DefineProp(?28?13???????????, { Value:    })
            Proto.DefineProp(?28?14???????????, { Value:    })
            Proto.DefineProp(?28?15?????????, { Value:    })
        }
    }

    ?16?5
???????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????
???????
    __New(Container, PropsInfoItemBase) {
        this.__InfoIndex := Map()
        this.__InfoIndex.Default := this.__InfoIndex.CaseSense := false
        this.__InfoItems := []
        this.__InfoItems.Capacity := this.__InfoIndex.Capacity := Container.Count
        for Prop, InfoItem in Container {
            this.__InfoItems.Push(InfoItem)
            this.__InfoIndex.Set(Prop, A_Index)
        }
        this.__PropsInfoItemBase := PropsInfoItemBase
        this.__FilterActive := 0
    }

    ?16?6
???????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????
???????
    Dispose() {
        this.__PropsInfoItemBase.DeleteProp(?28?16)
        this.__InfoIndex.Clear()
        this.__InfoIndex.Capacity := this.__InfoItems.Capacity := 0
        if this.__FilteredIndex {
            this.__FilteredIndex.Capacity := 0
        }
        if this.__FilteredItems {
            this.__FilteredItems.Clear()
            this.__FilteredItems.Capacity := 0
        }
        if this.Filter is Map {
            this.Filter.Clear()
            this.Filter.Capacity := 0
        }
        if this.HasOwnProp(?28?17?????????) {
            this.__FilterCache.Clear()
            this.__FilterCache.Capacity := 0
        }
        for Prop in this.OwnProps() {
            this.DeleteProp(Prop)
        }
        this.DefineProp(?28?18???, { Call: (*) =>    })
    }

    ?16?7
??????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????
????????????????????????????????????????????????????????????????
???????
    FilterActivate(CacheName?) {
        if !this.Filter {
            throw UnsetItemError(?28?19???????????????????????, -1)
        }
        Filter := this.Filter
        this.DefineProp(?28?20???????????, { Value: FilteredIndex := [] })
        this.DefineProp(?28?21???????????, { Value: FilteredItems := Map() })
        FilteredIndex.Capacity := FilteredItems.Capacity := this.__InfoItems.Length
        ?4?5??????????????????????????????????????????????????????????????????????????????????
        ?4?6??????????????????????????????????????????????????????????????????????????
        if Filter.Count == 1 {
            for FilterIndex, FilterObj in Filter {
                Fn := FilterObj
            }
            for InfoItem in this.__InfoItems {
                if Fn(InfoItem) {
                    continue
                }
                FilteredItems.Set(A_Index, InfoItem)
                FilteredIndex.Push(A_Index)
            }
        } else {
            for InfoItem in this.__InfoItems {
                for FilterIndex, FilterObj in Filter {
                    if FilterObj(InfoItem) {
                        continue 2
                    }
                }
                FilteredItems.Set(A_Index, InfoItem)
                FilteredIndex.Push(A_Index)
            }
        }
        FilteredIndex.Capacity := FilteredItems.Capacity := FilteredItems.Count
        this.__FilterActive := 1
        if IsSet(CacheName) {
            this.FilterCache(CacheName)
        }
        this.__FilterSwitchProps(1)
    }

    ?16?8
??????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????
???????
    FilterActivateFromCache(Name) {
        this.__FilterActive := 1
        this.__FilteredItems := this.__FilterCache.Get(Name).Items
        this.__FilteredIndex := this.__FilterCache.Get(Name).Index
        this.__FilterSwitchProps(1)
    }

    ?16?9
???????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????
??????
???????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????
????????????????????????????????????????????
????????????????????????????????????????
??????????????????????????????????????????
??????
???????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
??????????????????
?????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????
???????
    FilterAdd(Activate := true, Filters*) {
        if !this.Filter {
            this.DefineProp(?28?22??, { Value: Map() })
            this.Filter.Exclude :=   
            this.__FilterIndex := 5
        }
        this.DefineProp(?28?23?????, { Call: _FilterAdd })
        this.FilterAdd(Activate, Filters*)

        _FilterAdd(Self, Activate := true, Filters*) {
            Filter := Self.Filter
            for InfoItem in Filters {
                if IsObject(InfoItem) {
                    if InfoItem is Func || HasMethod(InfoItem, ?28?24) || HasMethod(InfoItem, '__Call') {
                        if !IsSet(Start) {
                            Start := Self.__FilterIndex
                        }
                        Filter.Set(Self.__FilterIndex, PropsInfo.Filter(InfoItem, Self.__FilterIndex++))
                    } else {
                        throw ValueError(?28?25???????????????????????????????????????????????????, -1
                        , ?28?26????????? Type(InfoItem))
                    }
                } else {
                    switch InfoItem, 0 {
                        case  4?,  14, '3', '4':
                            Filter.Set(InfoItem, PropsInfo.Filter(_Filter_%InfoItem%, InfoItem))
                        default:
                            if SubStr(Filter.Exclude, -1, 1) ==  5? {
                                Filter.Exclude .= InfoItem
                            } else {
                                Filter.Exclude .=  6? InfoItem
                            }
                            Flag_Exclude := true
                    }
                }
            }
            if IsSet(Flag_Exclude) {
                ?4?7?????????????????????????????????????????????????????????????????????????
                ?4?8??????????????????????????????????????????????????????????????????????????????????????
                Filter.Exclude .=  7?
                Filter.Set(0, PropsInfo.Filter(_Exclude, 0))
            }

            if Activate {
                Self.FilterActivate()
            }
            ?4?9????????????????????????????????????????????????????????????????????????????????????????
            return Start ??   

            _Exclude(InfoItem) {
                return InStr(Filter.Exclude,  8? InfoItem.Name  11)
            }
            _Filter_1(InfoItem) => !InfoItem.Index
            _Filter_2(InfoItem) => InfoItem.Index
            _Filter_3(InfoItem) => InfoItem.HasOwnProp( 9???)
            _Filter_4(InfoItem) => !InfoItem.HasOwnProp( 10??)
        }
    }

    ?16?10
?????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
???????
    FilterCache(Name) {
        if !this.__FilterCache {
            this.__FilterCache := Map()
        }
        this.DefineProp(?28?34???????, { Call: _Set })
        this.FilterCache(Name)
        _Set(Self, Name) => Self.__FilterCache.Set(Name, { Items: Self.__FilteredItems, Index: Self.__FilteredIndex })
    }

    ?16?11
?????????????????????????????????????
????????????????????????????????????????????????
???????
    FilterClear() {
        if !this.Filter {
            throw Error(?28?35????????????????, -1)
        }
        this.Filter.Clear()
        this.Filter.Capacity := 0
        this.Filter.Exclude :=   
    }

    ?16?12
???????????????????????????????????????????
??????????????????????????????????????????????????????
???????
    FilterClearCache() {
        if !this.__FilterCache {
            throw Error(?28?36??????????????????????, -1)
        }
        this.__FilterCache.Clear()
        this.__FilterCache.Capacity := 0
    }

    ?16?13
???????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????
???????????????????????????????????????????????????????????????
???????
    FilterDeactivate(CacheName?) {
        if !this.__FilterActive {
            throw Error(?28?37???????????????????????????????, -1)
        }
        if IsSet(CacheName) {
            this.FilterCache(CacheName)
        }
        this.__FilterActive := 0
        this.__FilteredItems :=   
        this.__FilteredIndex :=   
        this.__FilterSwitchProps(0)
    }

    ?16?14
???????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????
?????????????????????????????
?????????????????????????????????????????????????????????????
???????????????????????????????????????
????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????
???????
    FilterDelete(Key) {
        local r
        if Key is Func {
            ptr := ObjPtr(Key)
            for Index, FilterObj in this.Filter {
                if ObjPtr(FilterObj.Function) == ptr {
                    r := FilterObj
                    break
                }
            }
            if IsSet(r) {
                this.Filter.Delete(r.Index)
            } else {
                throw UnsetItemError(?28?38????????????????????????????????????????????????, -1)
            }
        } else if IsObject(Key) {
            r := this.Filter.Get(Key.Index)
            this.Filter.Delete(Key.Index)
        } else if IsNumber(Key) {
            r := this.Filter.Get(Key)
            this.Filter.Delete(Key)
        } else {
            for Fn in this.Filter {
                if Fn.Name == Key {
                    r := Fn
                    break
                }
            }
            if IsSet(r) {
                this.Filter.Delete(r.Index)
            } else {
                throw UnsetItemError(?28?39??????????????????????????????????????????????????, -2, Key)
            }
        }
        return r
    }

    ?16?15
???????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????
???????
    FilterDeleteFromCache(Name) {
        if !this.__FilterCache {
            throw Error(?28?40??????????????????????, -1)
        }
        r := this.__FilterCache.Get(Name)
        this.__FilterCache.Delete(Name)
        return r
    }

    ?16?16
????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????
???????
    FilterRemoveFromExclude(Name) {
        if !this.Filter {
            throw Error(?28?41????????????????, -1)
        }
        Filter := this.Filter
        for _name in StrSplit(Name,  12) {
            Filter.Exclude := RegExReplace(Filter.Exclude, ',' _name '(?=,)',   )
        }
    }

    ?16?17
??????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????
???????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????
???????
    Get(Key) {
        ?4?10???????????????
    }

    ?16?18
?????????????????????????????????????????????????????
???????????????????????????????????????????????????????
??????????????????????????????????????????????????????
???????
    GetIndex(Name) {
        return this.__InfoIndex.Get(Name)
    }

    ?16?19
????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????
?????????????????????????????????
???????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????
???????
    GetProxy(ProxyType) {
        switch ProxyType, 0 {
            case  13: return PropsInfo.Proxy_Array(this)
            case  24: return PropsInfo.Proxy_Map(this)
        }
        throw ValueError(?28?46???????????????????????????????????????????, -1
        , IsObject(ProxyType) ? ?28?47??????????????? Type(ProxyType) : ProxyType)
    }

    ?16?20
?????????????????????????????????????????????????????????????????????????????????????????
???????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
?????????????
??????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????
????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????
???????
    GetFilteredProps(Container?, Function?) {
        if IsSet(Container) {
            if Container is Array {
                Set := _Set_Array
                GetCount := () => Container.Length
            } else if Container is Map {
                if Container.CaseSense !==  15?? {
                    throw Error(?28?49???????????????????????????, -1)
                }
                Set := _Set_Map
                GetCount := () => Container.Count
            } else {
                throw TypeError(?28?50??????????????????????, -1, 'Type(Container) == ' Type(Container))
            }
        } else {
            Container := Map()
            Container.CaseSense := false
            Set := _Set_Map
            GetCount := () => Container.Count
            Flag_MakePropsInfo := true
        }
        InfoItems := this.__InfoItems
        Container.Capacity := InfoItems.Length
        if IsSet(Function)  {
            for InfoItem in InfoItems {
                if Function(InfoItem) {
                    continue
                }
                Set(InfoItem)
            }
        } else if this.Filter {
            Filter := this.Filter
            if Filter.Count == 1 {
                for FilterIndex, FilterObj in Filter {
                    Fn := FilterObj
                }
                for InfoItem in InfoItems {
                    if Fn(InfoItem) {
                        continue
                    }
                    Set(InfoItem)
                }
            } else {
                for InfoItem in Infoitems {
                    for FilterIndex, FilterObj in Filter {
                        if FilterObj(InfoItem) {
                            continue 2
                        }
                    }
                    Set(InfoItem)
                }
            }
        } else {
            throw Error(?28?51????????????????, -1)
        }
        Container.Capacity := GetCount()
        return IsSet(Flag_MakePropsInfo) ? PropsInfo(Container, this.__PropsInfoItemBase) : Container

        _Set_Array(InfoItem) => Container.Push(InfoItem)
        _Set_Map(InfoItem) => Container.Set(InfoItem.Name, InfoItem)
    }

    ?16?21
?????????????????????????????????????????????????????????????????????????
???????
    Has(Key) {
        return IsNumber(Key) ? this.__InfoItems.Has(Key) : this.__InfoIndex.Has(Key)
    }

    ?16?22
???????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????
???????
    ToArray(NamesOnly := false) {
        Result := []
        Result.Capacity := this.__InfoItems.Length
        if NamesOnly {
            for Item in this.__InfoItems {
                Result.Push(Item.Name)
            }
        } else {
            for Item in this.__InfoItems {
                Result.Push(Item)
            }
        }
        return Result
    }

    ?16?23
????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????
???????
    ToMap() {
        Result := Map()
        Result.Capacity := this.__InfoItems.Length
        for InfoItem in this.__InfoItems {
            Result.Set(InfoItem.Name, InfoItem)
        }
        return Result
    }

    ?16?24
???????????????????????
????????????????
????????????????
???????
    Capacity => this.__InfoIndex.Capacity
    ?16?25
???????????????????????
????????????????
????????????????
???????
    CaseSense => this.__InfoIndex.CaseSense
    ?16?26
???????????????????????
????????????????
????????????????
???????
    Count => this.__InfoIndex.Count
    ?16?27
???????????????????????
????????????????
????????????????
???????
    Default => this.__InfoIndex.Default
    ?16?28
???????????????????????
????????????????
????????????????
???????
    Length => this.__InfoItems.Length

    ?16?29
??????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????
??????????????????????????
????????????????
???????
    FilterActive {
        Get => this.__FilterActive
        Set {
            if Value {
                if this.__FilterCache.Has(Value) {
                    this.FilterActivateFromCache(Value)
                } else {
                    this.FilterActivate()
                }
            } else {
                this.FilterDeactivate()
            }
        }
    }

    ?16?30
???????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????
??????????????????????????
???????????????????????????????????????????????????
??????????????????????????
????????????????
???????
    StringMode {
        Get => this.__StringMode
        Set {
            if this.__FilterActive {
                if Value {
                    this.DefineProp(?28?52????????, { Value: 1 })
                    this.DefineProp( 16??, { Call: this.__FilteredGet_StringMode })
                } else {
                    this.DefineProp(?28?54????????, { Value: 0 })
                    this.DefineProp( 17??, { Call: this.__FilteredGet_Bitypic })
                }
            } else {
                if Value {
                    this.DefineProp(?28?56????????, { Value: 1 })
                    this.DefineProp( 18??, { Call: this.__ItemGet_StringMode })
                } else {
                    this.DefineProp(?28?58????????, { Value: 0 })
                    this.DefineProp( 19??, { Call: this.__ItemGet_Bitypic })
                }
            }
        }
    }

    __Delete() {
        this.Dispose()
    }

    ?16?31
????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????
???????
    __Enum(VarCount) {
        i := 0
        if this.__FilterActive {
            Index := this.__FilteredIndex
            FilteredItems := this.__FilteredItems
            return this.__StringMode ? _Filtered_Enum_StringMode_%VarCount% : _Filtered_Enum_%VarCount%
        } else {
            InfoItems := this.__InfoItems
            return this.__StringMode ? _Enum_StringMode_%VarCount% : _Enum_%VarCount%
        }

        _Enum_1(&InfoItem) {
            if ++i > InfoItems.Length {
                return 0
            }
            InfoItem := InfoItems[i]
            return 1
        }
        _Enum_2(&Prop, &InfoItem) {
            if ++i > InfoItems.Length {
                return 0
            }
            InfoItem := InfoItems[i]
            Prop := InfoItem.Name
            return 1
        }
        _Enum_StringMode_1(&Prop) {
            if ++i > InfoItems.Length {
                return 0
            }
            Prop := InfoItems[i].Name
            return 1
        }
        _Enum_StringMode_2(&Index, &Prop) {
            if ++i > InfoItems.Length {
                return 0
            }
            Index := i
            Prop := InfoItems[i].Name
            return 1
        }

        _Filtered_Enum_1(&InfoItem) {
            if ++i > Index.Length {
                return 0
            }
            InfoItem := FilteredItems[Index[i]]
            return 1
        }
        _Filtered_Enum_2(&Prop, &InfoItem) {
            if ++i > Index.Length {
                return 0
            }
            InfoItem := FilteredItems[Index[i]]
            Prop := InfoItem.Name
            return 1
        }
        _Filtered_Enum_StringMode_1(&Prop) {
            if ++i > Index.Length {
                return 0
            }
            Prop := FilteredItems[Index[i]]
            return 1
        }
        _Filtered_Enum_StringMode_2(&Index, &Prop) {
            if ++i > Index.Length {
                return 0
            }
            Index := i
            Prop := FilteredItems[Index[i]]
            return 1
        }
    }

    ?16?32
?????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????
???????
    __Item[Key] => this.Get(Key)

    __ItemGet_StringMode(Index) {
        if !IsNumber(Index) {
            this.__ThrowTypeError()
        }
        return this.__InfoItems[Index].Name
    }

    __ItemGet_Bitypic(Key) {
        return this.__InfoItems[IsNumber(Key) ? Key : this.__InfoIndex.Get(Key)]
    }

    __FilteredGet_StringMode(Index) {
        if !IsNumber(Index) {
            this.__ThrowTypeError()
        }
        return this.__InfoItems[this.__FilteredIndex[Index]].Name
    }

    __FilteredGet_Bitypic(Key) {
        if IsNumber(Key) {
            return this.__InfoItems[this.__FilteredIndex[Key]]
        } else {
            return this.__FilteredItems.Get(this.__InfoIndex.Get(Key))
        }
    }

    __FilteredHas(Key) {
        if IsNumber(Key) {
            return this.__FilteredItems.Has(this.__InfoIndex.Get(this.__InfoItems[Key].Name))
        } else {
            return this.__FilteredItems.Has(this.__InfoIndex.Get(Key))
        }
    }

    __FilteredToArray(NamesOnly := false) {
        Result := []
        Result.Capacity := this.__FilteredItems.Count
        if NamesOnly {
            for i, InfoItem in this.__FilteredItems {
                Result.Push(InfoItem.Name)
            }
        } else {
            for i, InfoItem in this.__FilteredItems {
                Result.Push(InfoItem)
            }
        }
        return Result
    }

    __FilteredToMap(NamesOnly := false) {
        Result := Map()
        Result.Capacity := this.__FilteredItems.Count
        for i, InfoItem in this.__FilteredItems {
            Result.Set(InfoItem.Name, InfoItem)
        }
        return Result
    }

    __FilterSwitchProps(Value) {
        Proto := PropsInfo.Prototype
        if Value {
            for Name in this.__OnFilterProperties {
                this.DefineProp(Name, Proto.GetOwnPropDesc(?28?60?????? Name))
            }
            this.DefineProp( 20??, Proto.GetOwnPropDesc(this.__StringMode ? '__FilteredGet_StringMode' : '__FilteredGet_Bitypic'))
        } else {
            for Name in this.__OnFilterProperties {
                this.DefineProp(Name, Proto.GetOwnPropDesc(Name))
            }
            this.DefineProp( 21??, Proto.GetOwnPropDesc(this.__StringMode ? '__ItemGet_StringMode' : '__ItemGet_Bitypic'))
        }
    }

    __ThrowTypeError() {
        ?4?11????????????????????????????????????????????????????????????????????????????????
        ?4?12?????????????????????????????????????????????????????????????????????????????????
        ?4?13??????????????????
        throw TypeError(?28?63????????????????????????????????????????????????????????????
        ?28?64??????????????????????????????????????????????, -2)
    }

    __FilteredCapacity => this.__FilteredItems.Capacity
    __FilteredCount => this.__FilteredItems.Count
    __FilteredLength => this.__FilteredItems.Count

    ?16?33
?????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????
????????????????????????????????????????????????????
?????????????????
???????
    class Filter {
        __New(Function, Index) {
            this.DefineProp(?28?65, { Call: _Filter })
            this.Function := Function
            this.Index := Index

            _Filter(Self, Item) {
                Function := this.Function
                return Function(Item)
            }
        }
        Name => this.Function.Name
    }

    ?16?34
???????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????
?????????????????
???????
    class Proxy_Array extends Array {
        static __New() {
            if this.Prototype.__Class == ?28?66????????????????? {
                this.Prototype.DefineProp(?28?67???, { Value: 'Array' })
            }
        }
        __New(Client) {
            this.DefineProp(?28?68??, { Value: Client })
        }
        Get(Index) => this.Client.Get(Index)
        Has(Index) => this.Client.__InfoItems.Has(Index)
        __Enum(VarCount) => this.Client.__Enum(VarCount)
        Capacity {
            Get => this.Client.__InfoItems.Capacity
            Set => this.Client.__InfoItems.Capacity := Value
        }
        Default {
            Get => this.Client.__InfoItems.Default
            Set => this.Client.__InfoItems.Default := Value
        }
        Length {
            Get => this.Client.__InfoItems.Length
            Set => this.Client.__InfoItems.Length := Value
        }
        __Item[Index] {
            Get => this.Client.__Item[Index]
            ?4?14???????????????????????????????????????????????????????????????????
            ?4?15??????????????????????????????????????
        }
        __Get(Name, Params) {
            if Params.Length {
                return this.Client.%Name%[Params*]
            } else {
                return this.Client.%Name%
            }
        }
        __Set(Name, Params, Value) {
            if Params.Length {
                return this.Client.%Name%[Params*] := Value
            } else {
                return this.Client.%Name% := Value
            }
        }
        __Call(Name, Params) {
            if Params.Length {
                return this.Client.%Name%(Params*)
            } else {
                return this.Client.%Name%()
            }
        }
    }

    ?16?35
?????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????
?????????????????
???????
    class Proxy_Map extends Map {
        static __New() {
            if this.Prototype.__Class == ?28?69??????????????? {
                this.Prototype.DefineProp(?28?70???, { Value: 'Map' })
            }
        }
        __New(Client) {
            this.DefineProp(?28?71??, { Value: Client })
        }
        Get(Key) => this.Client.Get(Key)
        Has(Key) => this.Client.__InfoIndex.Has(Key)
        __Enum(VarCount) => this.Client.__Enum(VarCount)
        Capacity {
            Get => this.Client.__InfoIndex.Capacity
            Set => this.Client.___InfoIndex.Capacity := Value
        }
        CaseSense => this.Client.__InfoIndex.CaseSense
        Count => this.Client.__InfoIndex.Count
        Default {
            Get => this.Client.__InfoIndex.Default
            Set => this.Client.__InfoIndex.Default := Value
        }
        __Item[Key] {
            Get => this.Client.__Item[Key]
            ?4?16???????????????????????????????????????????????????????????????????
            ?4?17????????????????????????????????????
        }
        __Get(Name, Params) {
            if Params.Length {
                return this.Client.%Name%[Params*]
            } else {
                return this.Client.%Name%
            }
        }
        __Set(Name, Params, Value) {
            if Params.Length {
                return this.Client.%Name%[Params*] := Value
            } else {
                return this.Client.%Name% := Value
            }
        }
        __Call(Name, Params) {
            if Params.Length {
                return this.Client.%Name%(Params*)
            } else {
                return this.Client.%Name%()
            }
        }
    }
}

?16?36
?????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????
???
class PropsInfoItem {
    static __New() {
        if this.Prototype.__Class == ?28?72????????? {
            this.Prototype.__KindNames := [?28?73,  25??, 'Get_Set',  26??, ?28?93?]
        }
    }

    ?16?37
????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????
?????????????
???????
    __New(Root) {
        this.Root := Root
    }

    ?16?38
?????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????
???????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????
???????
    GetFunc(&OutSet?, Flag_Bind := 0) {
        switch Flag_Bind, 0 {
            case  22:
                switch this.KindIndex {
                    case 1: return this.Call
                    case 2: return this.Get
                    case 3:
                        Set := this.Set
                        return this.Get
                    case 4: return this.Set
                    case 5: return   
                }
            case  23: return _Proc(this.Root)
            case '2': return _Proc(this.Owner)
            default: throw ValueError(?28?77????????????????????????????????????????????????, -1
            , IsObject(Flag_Bind) ? ?28?78??????????????? Type(Flag_Bind) : Flag_Bind)
        }

        _Proc(Obj) {
            switch this.KindIndex {
                case 1: return this.Call.Bind(Obj)
                case 2: return this.Get.Bind(Obj)
                case 3:
                    Set := this.Set.Bind(Obj)
                    return this.Get.Bind(Obj)
                case 4: return this.Set.Bind(Obj)
                case 5: return   
            }
        }
    }

    ?16?39
????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????
???????????????
?????????????????
???????????????????????????
???????????????????????????????????????
?????????
???????????????????????????
??????
?????????
?????????????????
????????????????????????????????
????????????????????????????????????????????
?????????
??????????????????
?????????????????????????????????????????
????????????????????????????????????????????????
????????????????????????????????????????????
????????????????????????????????????
???????????????????????????????????????
?????????????????????????????????????????????????????????????
????????
??????????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
????????????????????
????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????
???????
    GetOwner() {
        b := this.Root
        loop this.Index {
            b := b.Base
        }
        if b.HasOwnProp(this.Name) {
            return b
        } else {
            throw Error(?28?79?????????????????????????????????????, -1)
        }
    }

    ?16?40
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
????????????????
??????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????????
???????
    GetValue(&OutValue, FromOwner := false) {
        switch this.KindIndex {
            case 1, 4: return 1 ?4?18??????
            case 2, 3:
                try {
                    if FromOwner {
                        OutValue := (Get := this.Get)(this.Owner)
                    } else {
                        OutValue := (Get := this.Get)(this.Root)
                    }
                } catch Error as err {
                    OutValue := err
                    return 2
                }
            case 5:
                OutValue := this.Value
        }
    }

    ?16?41
????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????
???????????????????????????????????????????????
??????????????????????????????????????????????????????????
???????????????????????????????????????????????
??????????????????????????
???????
    Refresh() {
        desc := this.Owner.GetOwnPropDesc(this.Name)
        n := 0
        for Prop, Val in desc.OwnProps() {
            if this.HasOwnProp(Prop) {
                n++
            }
            this.DefineProp(Prop, { Value: Val })
        }
        switch this.KindIndex {
            case 1,2,4,5:
                ?4?19?????????????????????????
                if !n {
                    this.DeleteProp(this.Type)
                }
            case 3:
                ?4?20??????????????????????????????????
                if n == 1 {
                    if desc.HasOwnProp( 27??) {
                        this.DeleteProp( 29??)
                    } else {
                        this.DeleteProp( 28??)
                    }
                ?4?21?????????????????????????
                } else if !n {
                    this.DeleteProp( 30??)
                    this.DeleteProp( 31??)
                }
        }
        return this.__DefineKindIndex()
    }

    ?16?42
?????????????????????????????????????????????????????????????????????????????????
??????????????????????????????
????????????????
???????
    Owner => this.GetOwner()
    ?16?43
???????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????
?????????????
????????????
????????????????
????????????
??????????????
??????????????????????????????
????????????????
???????
    Kind => this.__KindNames[this.KindIndex]
    ?16?44
??????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????
?????????????????????????????
???????????????????????????????????????????????
??????????????????????????????????????????????????????????
???????????????????????????????????????????????
??????????????????????????
??????????????????????????????
????????????????
???????
    KindIndex => this.__DefineKindIndex()

    ?16?45
????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????
???????
    __DefineKindIndex() {
        ?4?22??????????????????????????????????????????????????????????
        if this.HasOwnProp(?28?85) {
            this.DefineProp(?28?86?????, { Value: 1 })
        } else if this.HasOwnProp('Get') {
            if this.HasOwnProp( 32??) {
                this.DefineProp(?28?89?????, { Value: 3 })
            } else {
                this.DefineProp(?28?90?????, { Value: 2 })
            }
        } else if this.HasOwnProp('Set') {
            this.DefineProp(?28?92?????, { Value: 4 })
        } else if this.HasOwnProp('Value') {
            this.DefineProp(?28?94?????, { Value: 5 })
        } else {
            throw Error(?28?95??????????????????????????????????, -1)
        }
        return this.KindIndex
    }
    ?16?46
?????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????
?????????????
???????
    __SetAlt(Item) {
        ?16?47
????????????????????????????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????
???????????????????
????????????????????????
?????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????
???????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????
?????????????????????????
????????????????????????????????????????????
??????????????????????????????????????????????????
?????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????
???????????????????
????????????????????????????????????????????????????????????????????
????????????
?????????????????????????????????????????????????????????????????????
??????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????
??????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????
??????????????????????
?????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????
???????????????????
????????????????????????????????????????????????????????????
????????????
??????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????
???????????????????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????
?????????????????????????????????????????????????????????????????????????????????
????????????????????
???????????
        this.Alt := [Item]
        this.DefineProp(?28?96????, { Call: (Self, Item) => Self.Alt.Push(Item) })
    }
}
